name: code review

on:
  pull_request:

jobs:
  code_review:
    runs-on: ubuntu-latest

    steps:
    - name: check out repository
      uses: actions/checkout@v2
      with:
        fetch-depth: 0 # fetch all of the git history

    - name: git diff
      run: |
        git fetch origin

        echo "Before commit SHA: ${{ github.event.pull_request.base.sha }}"
        echo "After commit SHA: ${{ github.event.pull_request.head.sha }}"
        echo $(git diff --unified=3 ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }})

        git diff --unified=3 ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} > diff.txt
        # cat diff.txt

        git_diff=$(cat diff.txt)
        echo "DIFF<<EOF" >> $GITHUB_ENV
        echo "$git_diff" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV
        
        echo "환경변수 확인"
        echo ${{env.DIFF}}


    - name: review to pull request
      uses: actions/github-script@v6
      env: 
        DIFF_CONTENT: ${{env.DIFF}}
      with:
        script: |
          const content = process.env.DIFF_CONTENT
          console.log("issue number" + context.issue.number)

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `${content}`
          })
      
